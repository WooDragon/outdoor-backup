# OpenWrt R5S SD卡备份系统架构设计

## 1. 系统架构概览

### 1.1 设计原则

- **可靠性优先**: 数据安全是最高优先级
- **最小侵入**: 尽量使用OpenWrt原生机制
- **高性能**: 充分利用R5S硬件优势
- **可维护**: 模块化设计，易于调试和扩展
- **兼容性**: 支持多种文件系统和SD卡格式

### 1.2 系统组件图

```
┌─────────────────────────────────────────────┐
│                  用户界面层                    │
├─────────────────────────────────────────────┤
│  LED指示器          系统日志 (logread)         │
└─────────────────────────────────────────────┘
                       ▼
┌─────────────────────────────────────────────┐
│                  触发机制层                    │
├─────────────────────────────────────────────┤
│     /etc/hotplug.d/block/90-sdcard-backup    │
│              (USB/SD卡热插拔检测)              │
└─────────────────────────────────────────────┘
                       ▼
┌─────────────────────────────────────────────┐
│                  核心服务层                    │
├─────────────────────────────────────────────┤
│   /opt/sdcard-backup/scripts/backup-manager  │
│      并发控制 | 状态管理 | 错误处理             │
└─────────────────────────────────────────────┘
                       ▼
┌─────────────────────────────────────────────┐
│                  执行引擎层                    │
├─────────────────────────────────────────────┤
│  SD卡检测  |  配置管理  |  rsync备份  |  日志  │
└─────────────────────────────────────────────┘
                       ▼
┌─────────────────────────────────────────────┐
│                  存储层                       │
├─────────────────────────────────────────────┤
│      /mnt/ssd/SDMirrors/{SD_UUID}/           │
│           内置SSD (SATA/NVMe)                 │
└─────────────────────────────────────────────┘
```

## 2. 目录结构设计

```
/opt/sdcard-backup/                 # 主程序目录
├── bin/
│   └── rsync                      # ARM架构静态编译rsync (可选)
├── scripts/
│   ├── backup-manager.sh          # 主备份管理脚本
│   ├── sdcard-setup.sh            # SD卡初始化脚本
│   ├── safety-check.sh            # 安全检查脚本
│   ├── led-control.sh             # LED控制脚本
│   └── common.sh                  # 公共函数库
├── conf/
│   └── backup.conf                # 全局配置文件
├── var/
│   ├── lock/                      # PID锁文件目录
│   └── status/                    # 状态文件目录
└── log/                           # 日志目录

/etc/hotplug.d/block/
└── 90-sdcard-backup               # 热插拔触发脚本

/mnt/ssd/SDMirrors/                # 备份数据存储
├── {UUID-1}/                      # SD卡1的备份
├── {UUID-2}/                      # SD卡2的备份
└── .logs/                         # 备份日志汇总
```

## 3. 核心组件设计

### 3.1 热插拔检测机制

**文件**: `/etc/hotplug.d/block/90-sdcard-backup`

**功能**:
- 监听块设备的add/remove事件
- 识别SD卡设备（通过设备路径判断）
- 触发备份管理器

**关键环境变量**:
- `$ACTION`: "add" 或 "remove"
- `$DEVNAME`: 设备名 (如 sda1)
- `$DEVPATH`: 设备路径
- `$DEVTYPE`: "partition" 表示可挂载分区

### 3.2 备份管理器

**文件**: `/opt/sdcard-backup/scripts/backup-manager.sh`

**核心功能**:
1. **并发控制**: PID锁机制，防止多重备份
2. **设备验证**: 确认是SD卡且可读取
3. **配置管理**: 读取/创建SD卡配置
4. **备份执行**: 调用rsync执行增量备份
5. **状态管理**: LED控制和日志记录
6. **错误处理**: 异常捕获和清理

**执行流程**:
```
获取锁 → 挂载SD卡 → 读取配置 → 执行备份 → 更新状态 → 释放锁
```

### 3.3 SD卡配置管理

**配置文件位置**: `{SD_ROOT}/FieldBackup.conf`

**配置内容**:
```bash
# SD卡唯一标识（自动生成UUID）
SD_UUID="550e8400-e29b-41d4-a716-446655440000"

# SD卡友好名称（可手动修改）
SD_NAME="Canon_5D4_Card1"

# 备份模式: PRIMARY(默认) 或 REPLICA
BACKUP_MODE="PRIMARY"

# 创建时间
CREATED_AT="2024-01-15 10:30:00"
```

### 3.4 LED状态指示

**控制接口**: `/sys/class/leds/`

**状态定义**:
| 状态 | LED表现 | 含义 |
|-----|--------|------|
| 备份中 | 绿灯快闪(100ms) | 正在执行备份 |
| 完成 | 绿灯常亮 | 备份成功完成 |
| 错误 | 红灯慢闪(500ms) | 备份失败 |
| 空闲 | 绿灯熄灭 | 无备份任务 |

### 3.5 日志系统

**日志级别**:
- INFO: 常规操作信息
- WARN: 警告但不影响备份
- ERROR: 错误需要关注
- DEBUG: 调试信息（可选）

**日志位置**:
- 系统日志: 通过`logger`写入syslog
- 备份日志: `/mnt/ssd/SDMirrors/.logs/{SD_UUID}.log`
- rsync日志: `/mnt/ssd/SDMirrors/.logs/rsync_{timestamp}.log`

## 4. 数据流设计

### 4.1 备份数据流

```
SD卡插入
    ↓
热插拔检测 (/etc/hotplug.d/block/)
    ↓
触发备份管理器
    ↓
挂载到 /mnt/sdcard/
    ↓
读取/创建 FieldBackup.conf
    ↓
rsync增量同步
    ├─ 源: /mnt/sdcard/
    └─ 目标: /mnt/ssd/SDMirrors/{UUID}/
    ↓
更新日志和状态
    ↓
LED指示完成
```

### 4.2 并发控制流

```
请求备份
    ↓
检查锁文件 (/opt/sdcard-backup/var/lock/backup.pid)
    ↓
锁存在？
    ├─ 是 → 等待(最多5分钟) → 超时则报错
    └─ 否 → 创建锁 → 执行备份 → 释放锁
```

## 5. 安全性设计

### 5.1 数据安全

1. **增量备份**: `rsync --ignore-existing`确保不覆盖已有文件
2. **只读检测**: 检测SD卡写保护状态
3. **完整性**: 备份后执行`sync`确保数据写入
4. **原子操作**: 使用临时文件+重命名保证配置文件原子性

### 5.2 系统安全

1. **权限控制**: 脚本权限755，日志权限644
2. **路径验证**: 严格验证挂载路径防止误操作
3. **资源限制**: 限制并发备份数量（默认1个）
4. **超时控制**: rsync设置合理超时避免卡死

### 5.3 错误恢复

1. **信号处理**: 捕获SIGINT/SIGTERM等信号
2. **清理机制**: 异常退出时自动清理锁文件
3. **断点续传**: rsync支持中断后继续
4. **回滚机制**: 配置错误时恢复默认值

## 6. 性能优化

### 6.1 硬件优势利用

- **多核CPU**: rsync可以充分利用多核
- **大内存**: 无需swap，减少I/O开销
- **SSD存储**: 写入速度可达500MB/s+
- **USB 3.0**: 读取速度可达400MB/s+

### 6.2 软件优化

1. **缓冲区调优**: 增大rsync缓冲区
2. **并行处理**: 小文件打包处理
3. **智能跳过**: 跳过系统文件和缓存
4. **压缩传输**: 可选启用压缩（CPU换I/O）

### 6.3 预期性能

| 数据量 | 原方案耗时 | 新方案预期 | 提升倍数 |
|-------|-----------|-----------|---------|
| 10GB | ~6分钟 | ~1分钟 | 6x |
| 50GB | ~30分钟 | ~5分钟 | 6x |
| 100GB | ~60分钟 | ~10分钟 | 6x |
| 200GB | ~120分钟 | ~20分钟 | 6x |

## 7. 扩展性设计

### 7.1 预留扩展点

1. **Web界面**: 预留UCI配置接口
2. **通知系统**: 预留webhook接口
3. **云备份**: 预留二级备份接口
4. **多卡并行**: 架构支持多卡同时备份

### 7.2 配置扩展

支持通过配置文件自定义：
- 备份路径
- rsync参数
- 文件过滤规则
- LED映射关系
- 日志级别

## 8. 兼容性考虑

### 8.1 文件系统支持

- ext4 (原生支持)
- exFAT (需要kmod-fs-exfat)
- NTFS (需要kmod-fs-ntfs3)
- FAT32 (原生支持)

### 8.2 设备兼容

- 标准USB读卡器
- USB-C读卡器
- 多合一读卡器
- 内置SD卡槽

### 8.3 OpenWrt版本

- 最低要求: OpenWrt 19.07
- 推荐版本: OpenWrt 22.03+
- 必需内核模块: block-mount, usb-storage